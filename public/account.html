<!DOCTYPE html>
<html>

<head>
    <script src="/assets/js/jquery.min.js"></script>
    <title>CovidBizLink</title>
    <script src="/assets/js/loadtemplate.js"></script>
</head>

<body>
    <div id="navbar"></div>
    <div id="terms" class="text-center">
        <a href="terms.html">Please read and agree to these terms. Without agreeing, you cannot sucessfully enter any data</a>
       
        <br>
        <label>I agree to the terms: <input type="checkbox" id="terms-checkbox"/></label>
    </div>


    <h4 class="text-center">Business</h4>
    <p class="text-center">(If you need help)</p>
    <div style="margin: 0px auto;width: 80%;max-width: 570px;">
        <form onsubmit="return false">
            <div class="form-group d-sm-flex d-md-flex d-lg-flex d-xl-flex justify-content-center align-items-center" style="padding: 0;min-width: 260px;"><label style="padding-right: 10px;min-width: 135px;" for="biz-name">Business Name:</label><input class="form-control" type="text" id="biz-bizname" required="" minlength="3"></div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;">Services Required:</label>
                <div class="d-flex flex-wrap">
                    <div>Once you receive assistance with a service, please uncheck the box in order to help volunteers see who really need help</div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-accounting"><label class="form-check-label" for="formCheck-1">Accounting</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-webdev"><label class="form-check-label" for="formCheck-1">Web Development</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-social media"><label class="form-check-label" for="formCheck-1">Social Media</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-online video platform"><label class="form-check-label" for="formCheck-1">Online Video Platform (Zoom, etc)</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-marketing/outreach"><label class="form-check-label" for="formCheck-1">Marketing/Outreach</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-organize"><label class="form-check-label" for="formCheck-1">Organizing</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-phone"><label class="form-check-label" for="formCheck-1">Phone Line</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-advertising"><label class="form-check-label" for="formCheck-1">Advertising</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-consulting"><label class="form-check-label" for="formCheck-1">Consulting</label></div>
                </div>
            </div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">Other Services:</label><input class="form-control" type="text" id="biz-other-serv" placeholder = "Really, anything!"></div>
            <div id="locationField" class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">Address:</label><input class="form-control" type="text" id="biz-address" placeholder = "enter your address" onFocus = "geolocate()" required=""></div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">About Your Business:</label><textarea class="form-control" id="biz-about" required=""></textarea></div>
            
            <div class="form-group d-flex" style="min-width: 260px;">
                <label style="min-width: 135px;" for="serv-other">Socials / Links:</label>
                <table id="biz-social-table">
                    <tr>
                        <td>  
                            <input class="form-control" type="text" id="biz-socials" />
                        </td>
                        <td>
                            <button class="btn btn-primary" id="add-social" type="button" onclick="addSocialRow('biz')">Add a link</button>
                        </td>
                    </tr>
                </table> 
                           </div>
            
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-helpFound">Found help? Please tell us about it here! Specify who helped you and how, <b>one volunteer per box</b>.</label>
            </div>
                <table id="help-table"> 
                <tr>
                    <td><textarea class="form-control" style="min-width: 450px;"id="biz-helpFound"></textarea></td>
                    <td><button class="btn btn-primary" id="add-helpBox" type="button" onclick="addHelpBox()">Add Volunteer!</button></td>
                    <!-- <td><textarea class="form-control" style="min-width: 450px;"id="biz-helpFound" required=""></textarea></td>
                    <td><button class="btn btn-primary" id="add-helpBox" type="button" onclick="addHelpBox()">Add another volunteer</button></td> -->
                </tr>
            </table>

            <div class="form-group"><button class="btn btn-primary" id="biz-submit" type="submit" onclick="savebiz()">Update</button></div>
            <div class="form-group"><button class="btn btn-primary" id="biz-delete" type="submit" style="background-color: #fa4d41;">Delete Data</button></div>
        </form>
    </div>
    <h4 class="text-center" style="padding-top: 59px;">Volunteer</h4>
    <p class="text-center">(If you want to help)</p>
    <div style="margin: 0px auto;width: 80%;max-width: 570px;">
        <form onsubmit="return false">
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;">Services Offered:</label>
                <div class="d-flex flex-wrap">
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-accounting"><label class="form-check-label" for="formCheck-1">Accounting</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-webdev"><label class="form-check-label" for="formCheck-1">Web Development</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-social media"><label class="form-check-label" for="formCheck-1">Social Media</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-online video platform"><label class="form-check-label" for="formCheck-1">Online Video Platform (Zoom, etc)</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-marketing/outreach"><label class="form-check-label" for="formCheck-1">Marketing/Outreach</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-organize"><label class="form-check-label" for="formCheck-1">Organizing</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-phone"><label class="form-check-label" for="formCheck-1">Phone Line</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-advertising"><label class="form-check-label" for="formCheck-1">Advertising</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-consulting"><label class="form-check-label" for="formCheck-1">Consulting</label></div>
                </div>
            </div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">Other Services:</label><input class="form-control" type="text" id="vol-other-serv" placeholder = "Really, anything!"></div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">About You:</label><textarea class="form-control" id="vol-about" required=""></textarea></div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">Socials / Links:</label>
                <table id="vol-social-table">
                    <tr>
                        <td>  
                            <input class="form-control" type="text" id="vol-socials" />
                        </td>
                        <td>
                            <button class="btn btn-primary" id="add-social" type="button" onclick="addSocialRow('vol')">Add a link</button>
                        </td>
                    </tr>
                </table> 
                
            
            
            </div>
            <div class="form-group"><button class="btn btn-primary" id="vol-submit" type="submit" onclick="savevol()">Update</button></div>
            <div class="form-group"><button class="btn btn-primary" id="vol-delete" type="submit" style="background-color: #fa4d41;">Delete Data</button></div>
        </form>
    </div><!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-app.js"></script>

<!-- Add Firebase products that you want to use -->
<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-firestore.js"></script>
 <script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-analytics.js"></script>
  </script>
<script>
    // TODO: Replace the following with your app's Firebase project configuration
    var firebaseConfig = {
      apiKey: "AIzaSyD-_Zm5y-K8xINw3m9eDeHBnAE4DqtSv50",
      authDomain: "covidsmallbizlink.firebaseapp.com",
      databaseURL: "https://covidsmallbizlink.firebaseio.com",
      projectId: "covidsmallbizlink",
      storageBucket: "covidsmallbizlink.appspot.com",
      appId: "1:131149431483:web:20f64b67ec10c9c53c1f9e",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    firebase.auth().onAuthStateChanged(function(user){
        if (user != null) {
            // Name, email address etc
            var name = user.displayName;
            var email = user.email;
            console.log("logged in");

            b = document.getElementById("sign-btn");
            b.style.display = "none";

            document.getElementById("account-welcome").innerText = "Hello, " + name;
            document.getElementById("account-drop").style.display = "";
        }
    });
</script>

<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjecfORtBvTXO6jbKbTGc9vmF0i1yBL9s&libraries=places&callback=initAutocomplete"></script> -->
<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkUOdZ5y7hMm0yrcCQoCvLwzdM6M8s5qk&callback=initMap"> </script> -->
<script src="assets/js/log.js"></script>

<script>
    function addHelpBox(){
        var table = document.getElementById("help-table")
        var row = table.insertRow(-1)
        var cell = row.insertCell()
        cell.innerHTML = "<td><textarea class='form-control' id='biz-helpFound' ></textarea></td>"
    }

    function addSocialRow(prefix){
        var table = document.getElementById(prefix + "-social-table")        
        var row = table.insertRow(-1) 
        var cell = row.insertCell()
        cell.innerHTML = "<input class='form-control' type='text' id='" + prefix + "-socials' />"
     }




    var uid, name, email, address, coords, lat, lng, geocoder, position;
    var db = firebase.firestore();
    


    var idlist = {
      biz: ['bizname', 'other-serv', 'address', 'about' ],
      vol: ['other-serv', 'about' ]
    };
    var servlist = ['accounting', 'webdev', 'phone', 'advertising', 'consulting', "social media", "organize","online video platform","marketing/outreach"];

    
    function recover_information(col, prefix) {
      db.collection(col).doc(uid).get().then(function(doc){
        if (doc.exists){
            document.getElementById("terms-checkbox").checked = true;
          idlist[prefix].forEach(function(id) {
            htmlid = prefix + '-' + id;
            document.getElementById(htmlid).value = doc.data()[id]
          });
          doc.data()['socials'].forEach(link=>{
                var table = document.getElementById(prefix +'-social-table')
                var len = table.getElementsByTagName("tr").length
                addSocialRow(prefix)
                table.getElementsByTagName("input")[len-1].value = link
            })
        if (prefix == "biz"){
            doc.data()['helpRecv'].forEach(entry=>{
                var table = document.getElementById('help-table')
                var len = table.getElementsByTagName("tr").length
                addHelpBox()
                table.getElementsByTagName("textarea")[len-1].value = entry
            })
            }

          doc.data()['services'].forEach(function(id) {
            htmlid = prefix + '-' + 'serv-' + id;
            document.getElementById(htmlid).checked = true;
          });
        } else {
          console.log("No such document!")
        }
      }).catch(function(error) {
            console.log("Error getting document:", error)
      });
    }
    firebase.auth().onAuthStateChanged(function(user){
        if (user == null) {
            window.location.replace('/sign.html');
        }

        uid = user.uid;
        name = user.displayName;
        email = user.email;

        recover_information("businesses", "biz")
        recover_information("volunteers", "vol")
        set_up_delete(uid);
        var events = [
            {ID:"biz-submit", eventType:"click", action: user.uid + "updated biz info", category:"update", event_label: "biz", value: 4},
            {ID:"vol-submit", eventType:"click", action: user.uid + "updated vol info", category:"update", event_label: "vol", value: 3}

        ]
        reportEvents(events)
    });

    function saveone(collection, prefix) {
        var values = {}
        idlist[prefix].forEach(function(id) {
          htmlid = prefix + '-' + id;
          values[id] = document.getElementById(htmlid).value;
            //save address
          if (id == "address") {
              address = values[id]
        }
        });

        values["email"] = email;
        values["name"] = name;
        values['services'] = []
        servlist.forEach(function(id) {
          htmlid = prefix + '-' + 'serv-' + id;
          if (document.getElementById(htmlid).checked) {
            values['services'].push(id)
          }
        });

        var socials = []
        var links = document.getElementById(prefix +'-social-table').getElementsByTagName('input')
        for (i = 0; i < links.length; i++){
            var link = links[i]
            if (link.value!="") {
                if (!link.value.match(/^https?:\/\//i)) {
                    url = 'https://' + link.value;
                } else{
                    url = link.value
                }
                socials.push(url)
            }
        }
        values["socials"] = socials 

        //if business, update coords
        if (prefix=="biz") {
            var address = document.getElementById('biz-address').value;
            geocoder.geocode({'address': address}, function(results, status) {
            if (status === 'OK') {
                position = results[0].geometry.location
                lat = Number(position["lat"]())
                lng = Number(position["lng"]())
                //add coords here
                values["lat"] = lat
                values["lng"] = lng
                console.log("updating")

                db.collection(collection).doc(uid).set(values);
            } 
            

            });
            var helpRecvArray = []
            var helpRecv = document.getElementById("help-table").getElementsByTagName("textarea")
            for (i=0; i < helpRecv.length; i++){
                helpRecvArray.push(helpRecv[i].value)//There has to be a better way
            }
            console.log("Help Received:", helpRecvArray)
            if (helpRecvArray[0] == ""){
                values["helpRecv"] = []
            } else{
                values["helpRecv"] = helpRecvArray
                 
            }

            db.collection(collection).doc(uid).set(values);
            console.log("updated")
        
        
        }
        //if volunteer, don't update coords
        else {
            db.collection(collection).doc(uid).set(values);
        }
        //update button
        document.getElementById(prefix + '-submit').innerText = "Updated!"



    }






    function savebiz() {
        var terms = document.getElementById("terms-checkbox").checked
        if(terms){
            var bizName = document.getElementById("biz-bizname").value == ""
            var biz_other_serv = document.getElementById("biz-other-serv").value == ""
            var biz_address = document.getElementById("biz-address").value == ""
            var biz_about = document.getElementById("biz-about").value == ""         
            if (!bizName && ! biz_other_serv && !biz_address && ! biz_about){
                saveone("businesses", "biz")
            } else{
                window.alert("Please fill out all fields!")
            }
        }else{
            window.alert("You did not agree to the terms of use policy")
            // location.reload()
        }
    }

    function savevol() {
        var terms = document.getElementById("terms-checkbox").checked
        if(terms){
            var vol_other_serv = document.getElementById("vol-other-serv").value == ""
            var vol_about = document.getElementById("vol-about").value == ""

            if(! vol_other_serv && ! vol_about){
                console.log("Saving data")
                saveone("volunteers", "vol")
            } else{
                 window.alert("Please fill out all fields!")
            }
        }else{
            window.alert("You did not agree to the terms of use policy")
            // location.reload()
        }
    }


    var placeSearch, autocomplete;

    var componentForm = {
    street_number: 'short_name',
    route: 'long_name',
    locality: 'long_name',
    administrative_area_level_1: 'short_name',
    country: 'long_name',
    postal_code: 'short_name'
    };

    function initAutocomplete() {
    // Create the autocomplete object, restricting the search predictions to
    // geographical location types.
    autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('biz-address'), {types: ['geocode']});

    // Avoid paying for data that you don't need by restricting the set of
    // place fields that are returned to just the address components.
    autocomplete.setFields(['address_component']);

    // When the user selects an address from the drop-down, populate the
    // address fields in the form.
    autocomplete.addListener('place_changed', fillInAddress);

    initMap();
    }

    function fillInAddress() {
    // Get the place details from the autocomplete object.
    var place = autocomplete.getPlace();

        for (var cname in componentForm) {
            document.getElementById(cname).value = '';
            document.getElementById(cname).disabled = false;
        }

    // Get each component of the address from the place details,
    // and then fill-in the corresponding field on the form.
    for (var i = 0; i < place.address_components.length; i++) {
        var addressType = place.address_components[i].types[0];
        if (componentForm[addressType]) {
        var val = place.address_components[i][componentForm[addressType]];
        document.getElementById(addressType).value = val;
        }
    }
    }

    // Bias the autocomplete object to the user's geographical location,
    // as supplied by the browser's 'navigator.geolocation' object.
    function geolocate() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
        var geolocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };
        var circle = new google.maps.Circle(
            {center: geolocation, radius: position.coords.accuracy});
        autocomplete.setBounds(circle.getBounds());
        });
    }
    }

    function initMap() {
        console.log("initializing geocoder")
        geocoder = new google.maps.Geocoder();
    }
    

    function geocodeAddress(geocoder, address) {
        var address = document.getElementById('biz-address').value;
        geocoder.geocode({'address': address}, function(results, status) {
        if (status === 'OK') {
            position = results[0].geometry.location
            console.log(position)
            lat = Number(position["lat"]())
            lng = Number(position["lng"]())
            
        } 
    });
}












</script>

<footer class="footer bg-light"></footer>
<script src="assets/js/jquery.min.js"></script>
<script src="assets/bootstrap/js/bootstrap.min.js"></script>
<script src="assets/js/bs-init.js"></script>
<script src="assets/js/dbload.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjecfORtBvTXO6jbKbTGc9vmF0i1yBL9s&libraries=places&callback=initAutocomplete"  async defer> </script>
<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkUOdZ5y7hMm0yrcCQoCvLwzdM6M8s5qk&callback=initMap"  async defer> </script> -->




</body>

</html>
