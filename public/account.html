<!DOCTYPE html>
<html>

<head>
            <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162071177-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-162071177-1');
    </script>



    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>CovidBizLink</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic">
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/fonts/simple-line-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="assets/css/main.css">
</head>

<body>
    <nav class="navbar navbar-light navbar-expand bg-light navigation-clean">
        <div class="container"><a class="navbar-brand" href="/index.html" style="padding-right: 25px;">Covid Biz Link</a><button data-toggle="collapse" class="navbar-toggler" data-target="#navcol-1"></button>
            <div class="collapse navbar-collapse" id="navcol-1">
                <ul class="nav navbar-nav">
                    <li class="nav-item" role="presentation"><a class="nav-link" href="/businesses.html">Businesses</a></li>
                    <li class="nav-item" role="presentation"><a class="nav-link" href="/volunteers.html">Volunteers</a></li>
                    <li class="nav-item" role="presentation"><a class="nav-link active" href="/account.html">Account<i class="fa fa-user" style="padding-left: 3px;"></i></a></li>
                </ul><a href="/contact.html" style="padding: 10px;padding-bottom: 0px;padding-right: 0;padding-top: 0;">Contact Us</a></div>

            
                </div>
            <div class="dropdown bg-primary border-primary shadow-sm" id="account-drop" style="padding: 7px;border-radius: 4px; display: none"><a class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false" id="account-welcome" href="#" style="color: rgb(255,255,255);">Dropdown </a>
                <div class="dropdown-menu" role="menu"><a class="dropdown-item" role="presentation" href="/account.html">Account</a><a class="dropdown-item" role="presentation" onclick="firebase.auth().signOut();window.location.replace(&#39;/index.html&#39;)">Sign Out</a></div>
            </div><a class="btn btn-primary ml-auto" role="button" id="sign-btn" href="/sign.html">Sign In/Sign Up</a></div>
    </nav>
    <h4 class="text-center">Business</h4>
    <p class="text-center">(If you need help)</p>
    <div style="margin: 0px auto;width: 80%;max-width: 570px;">
        <form onsubmit="return false">
            <div class="form-group d-sm-flex d-md-flex d-lg-flex d-xl-flex justify-content-center align-items-center" style="padding: 0;min-width: 260px;"><label style="padding-right: 10px;min-width: 135px;" for="biz-name">Business Name:</label><input class="form-control" type="text" id="biz-bizname" required="" minlength="3"></div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;">Services Required:</label>
                <div class="d-flex flex-wrap">
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-accounting"><label class="form-check-label" for="formCheck-1">Accounting</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-webdev"><label class="form-check-label" for="formCheck-1">Web Development</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-social media"><label class="form-check-label" for="formCheck-1">Social Media</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-online video platform"><label class="form-check-label" for="formCheck-1">Online Video Platform (Zoom, etc)</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-marketing/outreach"><label class="form-check-label" for="formCheck-1">Marketing/Outreach</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-organize"><label class="form-check-label" for="formCheck-1">Organizing</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-phone"><label class="form-check-label" for="formCheck-1">Phone Line</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-advertising"><label class="form-check-label" for="formCheck-1">Advertising</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="biz-serv-consulting"><label class="form-check-label" for="formCheck-1">Consulting</label></div>
                </div>
            </div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">Other Services:</label><input class="form-control" type="text" id="biz-other-serv" placeholder = "Really, anything!"></div>
            <div id="locationField" class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">Address:</label><input class="form-control" type="text" id="biz-address" placeholder = "enter your address" onFocus = "geolocate()" required=""></div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">About Your Business:</label><textarea class="form-control" id="biz-about" required=""></textarea></div>
            <div class="form-group d-flex" style="min-width: 260px;">
                <label style="min-width: 135px;" for="serv-other">Socials / Links:</label>
                <table id="biz-social-table">
                    <tr>
                        <td>  
                            <input class="form-control" type="text" id="biz-socials" />
                        </td>
                        <td>
                            <button class="btn btn-primary" id="add-social" type="button" onclick="addSocialRow('biz')">Add a link</button>
                        </td>
                    </tr>
                </table> 
                           </div>
            <div class="form-group"><button class="btn btn-primary" id="biz-submit" type="submit" onclick="savebiz()">Update</button></div>
            <div class="form-group"><button class="btn btn-primary" id="biz-delete" type="submit" style="background-color: #fa4d41;">Delete Data</button></div>
        </form>
    </div>
    <h4 class="text-center" style="padding-top: 59px;">Volunteer</h4>
    <p class="text-center">(If you want to help)</p>
    <div style="margin: 0px auto;width: 80%;max-width: 570px;">
        <form onsubmit="return false">
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;">Services Offered:</label>
                <div class="d-flex flex-wrap">
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-accounting"><label class="form-check-label" for="formCheck-1">Accounting</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-webdev"><label class="form-check-label" for="formCheck-1">Web Development</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-social media"><label class="form-check-label" for="formCheck-1">Social Media</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-online video platform"><label class="form-check-label" for="formCheck-1">Online Video Platform (Zoom, etc)</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-marketing/outreach"><label class="form-check-label" for="formCheck-1">Marketing/Outreach</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-organize"><label class="form-check-label" for="formCheck-1">Organizing</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-phone"><label class="form-check-label" for="formCheck-1">Phone Line</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-advertising"><label class="form-check-label" for="formCheck-1">Advertising</label></div>
                    <div class="form-check" style="padding-left: 34px;"><input class="form-check-input" type="checkbox" id="vol-serv-consulting"><label class="form-check-label" for="formCheck-1">Consulting</label></div>
                </div>
            </div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">Other Services:</label><input class="form-control" type="text" id="vol-other-serv" placeholder = "Really, anything!"></div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">About You:</label><textarea class="form-control" id="vol-about" required=""></textarea></div>
            <div class="form-group d-flex" style="min-width: 260px;"><label style="min-width: 135px;" for="serv-other">Socials / Links:</label>
                <table id="vol-social-table">
                    <tr>
                        <td>  
                            <input class="form-control" type="text" id="vol-socials" />
                        </td>
                        <td>
                            <button class="btn btn-primary" id="add-social" type="button" onclick="addSocialRow('vol')">Add a link</button>
                        </td>
                    </tr>
                </table> 
                
            
            
            </div>
            <div class="form-group"><button class="btn btn-primary" id="vol-submit" type="submit" onclick="savevol()">Update</button></div>
            <div class="form-group"><button class="btn btn-primary" id="vol-delete" type="submit" style="background-color: #fa4d41;">Delete Data</button></div>
        </form>
    </div><!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-app.js"></script>

<!-- Add Firebase products that you want to use -->
<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-firestore.js"></script>
 <script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-analytics.js"></script>
  </script>
<script>
    // TODO: Replace the following with your app's Firebase project configuration
    var firebaseConfig = {
      apiKey: "AIzaSyD-_Zm5y-K8xINw3m9eDeHBnAE4DqtSv50",
      authDomain: "covidsmallbizlink.firebaseapp.com",
      databaseURL: "https://covidsmallbizlink.firebaseio.com",
      projectId: "covidsmallbizlink",
      storageBucket: "covidsmallbizlink.appspot.com",
      appId: "1:131149431483:web:20f64b67ec10c9c53c1f9e",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    firebase.auth().onAuthStateChanged(function(user){
        if (user != null) {
            // Name, email address etc
            var name = user.displayName;
            var email = user.email;
            console.log("yes");
            console.log(name);

            b = document.getElementById("sign-btn");
            b.style.display = "none";

            document.getElementById("account-welcome").innerText = "Hello, " + name;
            document.getElementById("account-drop").style.display = "";
        }
    });
</script>

<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjecfORtBvTXO6jbKbTGc9vmF0i1yBL9s&libraries=places&callback=initAutocomplete"></script> -->
<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkUOdZ5y7hMm0yrcCQoCvLwzdM6M8s5qk&callback=initMap"> </script> -->
<script src="assets/js/log.js"></script>

<script>


    function addSocialRow(prefix){
        var table = document.getElementById(prefix + "-social-table")        
        var row = table.insertRow(-1) 
        var cell = row.insertCell()
        cell.innerHTML = "<input class='form-control' type='text' id='" + prefix + "-socials' />"
     }




    var uid, name, email, address, coords, lat, lng, geocoder, position;
    var db = firebase.firestore();
    


    var idlist = {
      biz: ['bizname', 'other-serv', 'address', 'about' ],
      vol: ['other-serv', 'about' ]
    };
    var servlist = ['accounting', 'webdev', 'phone', 'advertising', 'consulting', "social media", "organize","online video platform","marketing/outreach"];

    
    function recover_information(col, prefix) {
      db.collection(col).doc(uid).get().then(function(doc){
        if (doc.exists){

          idlist[prefix].forEach(function(id) {
            htmlid = prefix + '-' + id;
            document.getElementById(htmlid).value = doc.data()[id]
          });

          doc.data()['services'].forEach(function(id) {
            htmlid = prefix + '-' + 'serv-' + id;
            document.getElementById(htmlid).checked = true;
          });
        } else {
          console.log("No such document!")
        }
      }).catch(function(error) {
            console.log("Error getting document:", error)
      });
    }
    firebase.auth().onAuthStateChanged(function(user){
        if (user == null) {
            window.location.replace('/sign.html');
        }

        uid = user.uid;
        name = user.displayName;
        email = user.email;

        recover_information("businesses", "biz")
        recover_information("volunteers", "vol")
        set_up_delete(uid);
        var events = [
            {ID:"biz-submit", eventType:"click", action: user.uid + "updated biz info", category:"update", event_label: "biz", value: 4},
            {ID:"vol-submit", eventType:"click", action: user.uid + "updated vol info", category:"update", event_label: "vol", value: 3}

        ]
        reportEvents(events)
    });

    function saveone(collection, prefix) {
        var values = {}
        idlist[prefix].forEach(function(id) {
          htmlid = prefix + '-' + id;
          values[id] = document.getElementById(htmlid).value;
            //save address
          if (id == "address") {
              address = values[id]
        //   } else if (id == "socials") {
        //       console.log(values[id], id)
        //          (!values[id].match(/^https?:\/\//i)) {
        //             console.log("url altered")
        //             values[id] = 'https://' + values[id];
        //         }
        }
        });

        values["email"] = email;
        values["name"] = name;
        values['services'] = []
        servlist.forEach(function(id) {
          htmlid = prefix + '-' + 'serv-' + id;
        console.log(htmlid)
          if (document.getElementById(htmlid).checked) {
            values['services'].push(id)
          }
        });

        var socials = []
        var links = document.getElementById(prefix +'social-table').getElementsByTagName('input')
        links.forEach(link=>{
            if (!link.value.match(/^https?:\/\//i)) {
                console.log("url altered")
                url = 'https://' + link.value;
            } else{
                url = link.value
            }
            socials.push(url)
        })
        values["social"] = socials 

        //if business, update coords
        if (prefix=="biz") {
            var address = document.getElementById('biz-address').value;
            geocoder.geocode({'address': address}, function(results, status) {
            if (status === 'OK') {
                position = results[0].geometry.location
                lat = Number(position["lat"]())
                lng = Number(position["lng"]())
                console.log(lat, lng)
                //add coords here
                values["lat"] = lat
                values["lng"] = lng
                console.log(values)

                console.log("updating")

                db.collection(collection).doc(uid).set(values);
            } 
            

            });
        }
        //if volunteer, don't update coords
        else {
            db.collection(collection).doc(uid).set(values);
        }
        //update button
        document.getElementById(prefix + '-submit').innerText = "Updated!"



    }

    function savebiz() {
        saveone("businesses", "biz")
    }

    function savevol() {

        saveone("volunteers", "vol")
    }


    var placeSearch, autocomplete;

    var componentForm = {
    street_number: 'short_name',
    route: 'long_name',
    locality: 'long_name',
    administrative_area_level_1: 'short_name',
    country: 'long_name',
    postal_code: 'short_name'
    };

    function initAutocomplete() {
    // Create the autocomplete object, restricting the search predictions to
    // geographical location types.
    autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('biz-address'), {types: ['geocode']});

    // Avoid paying for data that you don't need by restricting the set of
    // place fields that are returned to just the address components.
    autocomplete.setFields(['address_component']);

    // When the user selects an address from the drop-down, populate the
    // address fields in the form.
    autocomplete.addListener('place_changed', fillInAddress);

    initMap();
    }

    function fillInAddress() {
    // Get the place details from the autocomplete object.
    var place = autocomplete.getPlace();

        for (var cname in componentForm) {
            document.getElementById(cname).value = '';
            document.getElementById(cname).disabled = false;
        }

    // Get each component of the address from the place details,
    // and then fill-in the corresponding field on the form.
    for (var i = 0; i < place.address_components.length; i++) {
        var addressType = place.address_components[i].types[0];
        if (componentForm[addressType]) {
        var val = place.address_components[i][componentForm[addressType]];
        document.getElementById(addressType).value = val;
        }
    }
    }

    // Bias the autocomplete object to the user's geographical location,
    // as supplied by the browser's 'navigator.geolocation' object.
    function geolocate() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
        var geolocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };
        var circle = new google.maps.Circle(
            {center: geolocation, radius: position.coords.accuracy});
        autocomplete.setBounds(circle.getBounds());
        });
    }
    }

    function initMap() {
        console.log("initializing geocoder")
        geocoder = new google.maps.Geocoder();
    }
    

    function geocodeAddress(geocoder, address) {
        var address = document.getElementById('biz-address').value;
        geocoder.geocode({'address': address}, function(results, status) {
        if (status === 'OK') {
            position = results[0].geometry.location
            console.log(position)
            lat = Number(position["lat"]())
            lng = Number(position["lng"]())
            
        } 
    });
}












</script>

    <footer class="footer bg-light">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 my-auto h-100 text-center text-lg-left">
                    <p class="text-muted small mb-4 mb-lg-0">© Covid Biz Link 2020. All Rights Reserved.</p>
                </div>
                <div class="col-lg-6 my-auto h-100 text-center text-lg-right">
                    <p>Created by&nbsp;Andrew Ferruolo,&nbsp; Lucien Gaitskell,&nbsp;Myles Johnson, William Kopans,&nbsp; and Daniel Wang.</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="assets/js/dbload.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjecfORtBvTXO6jbKbTGc9vmF0i1yBL9s&libraries=places&callback=initAutocomplete"  async defer> </script>
    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkUOdZ5y7hMm0yrcCQoCvLwzdM6M8s5qk&callback=initMap"  async defer> </script> -->




</body>

</html>
