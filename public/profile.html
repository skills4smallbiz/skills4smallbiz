<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>CovidBizLink</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic">
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/fonts/simple-line-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="assets/css/main.css">
</head>

<body>
    <nav class="navbar navbar-light navbar-expand bg-light navigation-clean">
        <div class="container"><a class="navbar-brand" href="/index.html" style="padding-right: 25px;">Covid Biz Link</a><button data-toggle="collapse" class="navbar-toggler" data-target="#navcol-1"></button>
            <div class="collapse navbar-collapse" id="navcol-1">
                <ul class="nav navbar-nav">
                    <li class="nav-item" role="presentation"><a class="nav-link" href="/businesses.html">Businesses</a></li>
                    <li class="nav-item" role="presentation"><a class="nav-link" href="/volunteers.html">Volunteers</a></li>
                    <li class="nav-item" role="presentation"><a class="nav-link" href="/account.html">Account<i class="fa fa-user" style="padding-left: 3px;"></i></a></li>
                </ul>
            </div>
            <div class="dropdown bg-primary border-primary shadow-sm" id="account-drop" style="padding: 7px;border-radius: 4px; display: none"><a class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false" id="account-welcome" href="#" style="color: rgb(255,255,255);">Dropdown </a>
                <div class="dropdown-menu" role="menu"><a class="dropdown-item" role="presentation" href="/account.html">Account</a><a class="dropdown-item" role="presentation" onclick="firebase.auth().signOut();window.location.replace(&#39;/index.html&#39;)">Sign Out</a></div>
            </div><a class="btn btn-primary ml-auto" role="button" id="sign-btn" href="/sign.html">Sign In/Sign Up</a></div>
    </nav>
    <section style="padding: 35px;padding-top: 55px;padding-bottom: 55px;">
        <div class="col-lg-4" id="profile" style="width: 70%; margin: auto; width: 80%; border: 3px solid rgb(0,97,128); padding: 2%;">
            <h3 id="profile-name" class="name"></h3>
            <h3 id="profile-bizname" class="name">&nbsp;</h3>
            <p id="profile-address" class="title">Address:&nbsp;</p>
            <p id="profile-services" class="title">Services:&nbsp;</p>
            <p id="profile-other-serv" class="description">Other Services:&nbsp;</p>
            <p id="profile-about" class="description">About:&nbsp;</p>
            <p id="profile-socials" class="description"></p>
            <a class="btn btn-primary ml-auto" role="button" id="contact">Contact</a>
        </div>
        
        <div id = "map"></div>
    </section><!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-app.js"></script>

<!-- Add Firebase products that you want to use -->
<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-firestore.js"></script>
<!-- Previously loaded Firebase SDKs -->

<script 
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjecfORtBvTXO6jbKbTGc9vmF0i1yBL9s">
</script>

<script>
    // TODO: Replace the following with your app's Firebase project configuration
    var firebaseConfig = {
      apiKey: "AIzaSyD-_Zm5y-K8xINw3m9eDeHBnAE4DqtSv50",
      authDomain: "covidsmallbizlink.firebaseapp.com",
      databaseURL: "https://covidsmallbizlink.firebaseio.com",
      projectId: "covidsmallbizlink",
      storageBucket: "covidsmallbizlink.appspot.com",
      appId: "1:131149431483:web:20f64b67ec10c9c53c1f9e",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    firebase.auth().onAuthStateChanged(function(user){
        if (user != null) {
            // Name, email address etc
            var name = user.displayName;
            var email = user.email;
            console.log("yes");
            console.log(name);

            b = document.getElementById("sign-btn");
            b.style.display = "none";

            document.getElementById("account-welcome").innerText = "Hello, " + name;
            document.getElementById("account-drop").style.display = "";
        }
    });
</script>
<script src="assets/js/dbload.js"></script>

<script>
    Array.prototype.forEach.call(document.getElementById("profile").children, function(n) {
        n.style.display = "none";
    });
    
    var db = firebase.firestore();
    var prefix = "biz";
    
    function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
            vars[key] = value;
        });
        return vars;
    }
    var uid, name, email;
    var button_name;
    var about, services, socials, bizname, lat, lng;
    var userid = getUrlVars()['user'];
    var col = getUrlVars()['type'];
    console.log(userid)
    console.log(col)

    var keys;
    if (col == "businesses") {
        //add lat and lng
        keys = ["bizname", "address", "services", "other-serv", "about", "socials"]
    } else if (col == "volunteers") {
        keys = ["name", "services", "other-serv", "about", "socials"]
    }
    
    firebase.auth().onAuthStateChanged(function (user) {
        //recover info from db and update relevant fields
        db.collection(col).doc(userid).get().then(function(doc){
            if (doc.exists){
                console.log("retrieving info")
                var data = doc.data();

                keys.forEach(function(id) {
                    console.log(id)
                    var fmtData = data[id];
                    
                    if (id == "services") {
                       fmtData = formatServices(fmtData);
                    }
                    
                    textDoc = document.getElementById('profile-' + id)
                    textDoc.innerText += fmtData;

                    if (id == "socials") {
                        textDoc.style.textDecoration = "underline";
                        textDoc.addEventListener("click", () => {
                            window.open(fmtData)
                        })
                    }
                    textDoc.style.display = "";
                });
                
                //email
                email = data["email"]
                //set email
                document.getElementById("contact").href = "mailto:" + email;

                if (col == "businesses") {
                    //latitude and longitute
                    lat = data["lat"]
                    lng = data["lng"]
                    //initialize the map
                    initMap(lat, lng)
                }

                console.log("updating info")
            } else {
              console.log("No such document!")
            }
        }).catch(function(error) {
            console.log("Error getting document:", error)
        });

        
    });

    //mapping the business given lat and lng
    function initMap(latitutde, longitude) {
        // The location of the biz
        var loc = {lat: latitutde, lng: longitude};
        // The map, centered at the business
        var map = new google.maps.Map(
            document.getElementById('map'), {zoom: 13, center: loc});
        // The marker, positioned at the business
        var marker = new google.maps.Marker({position: loc, map: map});
        console.log("map init")
    }

    

    //override css to make button visible
    document.getElementById("contact").style = "";


</script>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="assets/js/dbload.js"></script>
    <!-- daniel's account -->


    <style>
        #map {
            height: 300px;  /* The height is 400 pixels */
            width: 70%;  /* The width is the width of the web page */
            margin: 0 auto;
 }
    </style>

</body>

</html>